name: ally360

services:
  postgres:
    image: postgres:15
    container_name: ally360-postgres
    restart: unless-stopped
    env_file: [./env/.env]
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [ally360]

  redis:
    image: redis:7-alpine
    container_name: ally360-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [ally360]

  minio:
    image: minio/minio:latest
    container_name: ally360-minio
    restart: unless-stopped
    env_file: [./env/.env]
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    expose: ["9000", "9001"]
    networks: [ally360]

  # ===== One-shot migrations (must complete before API/Celery) =====
  migrations:
    image: ghcr.io/ally-360/ally360-api:${IMAGE_TAG:-main}
    container_name: ally360-migrations
    restart: "no"
    depends_on:
      postgres: { condition: service_healthy }
    env_file: [./env/.env]
    environment:
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
      MINIO_HOST: minio
      MINIO_PUBLIC_HOST: ${MINIO_PUBLIC_HOST:-s3.ally360.co}
      MINIO_PUBLIC_PORT: ${MINIO_PUBLIC_PORT:-443}
      MINIO_PUBLIC_USE_SSL: ${MINIO_PUBLIC_USE_SSL:-true}
      AUTO_RUN_MIGRATIONS: "false"
      ALLOW_MIGRATION_CREATION: "false"
    command: ["python3", "/code/migrate.py", "upgrade"]
    networks: [ally360]

  # ===== API: dos r√©plicas activas para LB y rolling update =====
  api-a:
    image: ghcr.io/ally-360/ally360-api:${IMAGE_TAG:-main}
    container_name: ally360-api-a
    restart: unless-stopped
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
      minio: { condition: service_started }
      migrations: { condition: service_completed_successfully }
    env_file: [./env/.env]
    environment:
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
      MINIO_HOST: minio
      MINIO_PUBLIC_HOST: ${MINIO_PUBLIC_HOST:-s3.ally360.co}
      MINIO_PUBLIC_PORT: ${MINIO_PUBLIC_PORT:-443}
      MINIO_PUBLIC_USE_SSL: ${MINIO_PUBLIC_USE_SSL:-true}
      AUTO_RUN_MIGRATIONS: "false"
      ALLOW_MIGRATION_CREATION: "false"
    expose: ["8000"]
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/health', timeout=2).read()"]
      interval: 10s
      timeout: 5s
      retries: 15
    networks: [ally360]

  api-b:
    image: ghcr.io/ally-360/ally360-api:${IMAGE_TAG:-main}
    container_name: ally360-api-b
    restart: unless-stopped
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
      minio: { condition: service_started }
      migrations: { condition: service_completed_successfully }
    env_file: [./env/.env]
    environment:
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
      MINIO_HOST: minio
      MINIO_PUBLIC_HOST: ${MINIO_PUBLIC_HOST:-s3.ally360.co}
      MINIO_PUBLIC_PORT: ${MINIO_PUBLIC_PORT:-443}
      MINIO_PUBLIC_USE_SSL: ${MINIO_PUBLIC_USE_SSL:-true}
      AUTO_RUN_MIGRATIONS: "false"
      ALLOW_MIGRATION_CREATION: "false"
    expose: ["8000"]
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/health', timeout=2).read()"]
      interval: 10s
      timeout: 5s
      retries: 15
    networks: [ally360]

  celery-worker:
    image: ghcr.io/ally-360/ally360-api:${IMAGE_TAG:-main}
    container_name: ally360-celery-worker
    restart: unless-stopped
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
      minio: { condition: service_started }
      migrations: { condition: service_completed_successfully }
    entrypoint: []
    command: celery -A app.core.celery worker --loglevel=info -Q email,files,products,celery
    env_file: [./env/.env]
    environment:
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
      MINIO_HOST: minio
      MINIO_PUBLIC_HOST: ${MINIO_PUBLIC_HOST:-s3.ally360.co}
      MINIO_PUBLIC_PORT: ${MINIO_PUBLIC_PORT:-443}
      MINIO_PUBLIC_USE_SSL: ${MINIO_PUBLIC_USE_SSL:-true}
      AUTO_RUN_MIGRATIONS: "false"
      ALLOW_MIGRATION_CREATION: "false"
    networks: [ally360]

  celery-beat:
    image: ghcr.io/ally-360/ally360-api:${IMAGE_TAG:-main}
    container_name: ally360-celery-beat
    restart: unless-stopped
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
      minio: { condition: service_started }
      migrations: { condition: service_completed_successfully }
    entrypoint: []
    command: celery -A app.core.celery beat --loglevel=info
    env_file: [./env/.env]
    environment:
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
      MINIO_HOST: minio
      MINIO_PUBLIC_HOST: ${MINIO_PUBLIC_HOST:-s3.ally360.co}
      MINIO_PUBLIC_PORT: ${MINIO_PUBLIC_PORT:-443}
      MINIO_PUBLIC_USE_SSL: ${MINIO_PUBLIC_USE_SSL:-true}
      AUTO_RUN_MIGRATIONS: "false"
      ALLOW_MIGRATION_CREATION: "false"
    networks: [ally360]

  # ===== Frontend ERP (allyapp) =====
  allyapp:
    image: ghcr.io/ally-360/webpage-platform:latest
    container_name: ally360-allyapp
    restart: unless-stopped
    expose: ["80"]
    networks: [ally360]

  # ===== Homepage (Next.js) =====
  # TODO: publicar la imagen real de homepage en GHCR (ej: ghcr.io/ally-360/ally360-web:latest)
  ally360-web:
    image: ${ALLY360_WEB_IMAGE:-ghcr.io/ally-360/ally360-web:latest}
    container_name: ally360-web
    restart: unless-stopped
    expose: ["3000"]
    networks: [ally360]

  # ===== Caddy: TLS + reverse proxy =====
  caddy:
    image: caddy:2
    container_name: ally360-caddy
    restart: unless-stopped
    ports: ["80:80", "443:443"]
    env_file: [./env/.env]
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - api-a
      - api-b
      - allyapp
      - ally360-web
      - minio
    networks: [ally360]

volumes:
  postgres-data:
  redis-data:
  minio-data:
  caddy_data:
  caddy_config:

networks:
  ally360:
    driver: bridge
